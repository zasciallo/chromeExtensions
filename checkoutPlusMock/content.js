let productHTML = `
<div role="row" class="_6zbcq51i _6zbcq51h _1fragem3c _1fragem2x _6zbcq51l _6zbcq510 _6zbcq51k">
  <div role="cell" class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51t _6zbcq51q _1fragem8w _6zbcq51o">
    <div class="_1fragem32 _1fragemn2 _16s97g74b" style="--_16s97g746: 6.4rem;">
      <div class="_5uqybw0 _1fragemn2 _1fragem3c _1fragem8h">
        <div class="_5uqybw1 _1fragem3c _1fragemm3 _1fragempd _1fragem50 _1fragem6t _1fragemu _1fragemnw _1fragem8h">
          <div class="_1m6j2n34 _1m6j2n33 _1fragemn2 _1fragemuv _1m6j2n3a _1m6j2n39 _1m6j2n35" style="--_1m6j2n30: 1;">
            <picture>
              <source media="(min-width: 0px)"
                srcset="https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_64x64.png?v=1707406598 1x, https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_128x128.png?v=1707406598 2x, https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_256x256.png?v=1707406598 4x">
              <img src="https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_64x64.png?v=1707406598"
                loading="eager" alt="SavedBy Package Protection"
                class="_1h3po425 _1h3po424 _1fragem32 _1fragemly _1fragemlo _1h3po426 _1fragemqd _1fragemqb _1fragemqf _1fragemq9 _1fragemre _1fragemra _1fragemri _1fragemr6 _1fragemci _1fragemby _1fragemd2 _1fragembe _1fragemmd _1m6j2n3c _1fragempz _1fragem2x _1m6j2n35">
            </picture>
            <div class="_1m6j2n3m _1m6j2n3l _1fragemms">
              <div
                class="_99ss3s1 _99ss3s0 _1fragemns _1fragem87 _1fragemq0 _99ss3s6 _99ss3s2 _1fragem3c _99ss3sh _99ss3sc _99ss3sa _1fragemjb _1fragemhi _99ss3su _99ss3sp _1fragemql _1fragemqr _1fragemr3 _1fragemqx">
                <span class="_99ss3sw _1fragemtu">Quantity</span><span>1</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div role="cell"
    class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51u _6zbcq51r _1fragem87 _6zbcq51p _6zbcq51n _1fragemny _6zbcq51x _6zbcq51w _1fragempa _16s97g741"
    style="--_16s97g73w: 6.4rem;">
    <div class="_1fragem32 _1fragemn2 dDm6x">
      <p class="_1tx8jg70 _1fragemn2 _1tx8jg7c _1tx8jg7b _1fragempg _1tx8jg715 _1tx8jg71d _1tx8jg71f">SavedBy Package
        Protection</p>
      <div class="_1ip0g651 _1ip0g650 _1fragemn2 _1fragem5z _1fragem7s _1fragem41">
        <p class="_1tx8jg70 _1fragemn2 _1tx8jg7a _1tx8jg79 _1fragempf _1tx8jg715 _1tx8jg71e _1tx8jg71f">$1.97</p>
        <ul class="_1ip0g651 _1ip0g650 _1fragemn2 _1fragem4g _1fragem69 _1fragem41"></ul>
      </div>
      <div class="Geu8c" style="">
        <div class="M4bqA Geu8c" style="">
          <div class="_1fragem32 _1fragemn2">
            <div><button aria-busy="false" aria-label="Remove SavedBy" aria-live="polite" type="button"
                class="_1m2hr9ge _1m2hr9gd _1fragemum _1fragemn2 _1fragemp4 _1fragemu0 _1fragemuf _1fragemuh _1fragemu6 _1m2hr9g1h _1m2hr9g1e _1fragemuh _1fragemuf _1fragemu5 _1fragemtr _1m2hr9gi _1m2hr9gg _1fragem3m _1m2hr9g1w _1m2hr9g1b _1m2hr9g1j _1m2hr9g1i _1fragemu2"><span
                  class="_1m2hr9gv _1m2hr9gu _1fragemtw _1fragemub _1fragemu5 _1fragemui _1m2hr9gr _1m2hr9gp _1fragem3c _1fragem87 _1fragemty">Remove</span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div role="cell" class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51u _6zbcq51r _1fragem87 _6zbcq51o _6zbcq51y">
    <div class="_6zbcq522 _1fragemtu"><span class="_19gi7yt0 _19gi7yt12 _19gi7yt1a _19gi7yt1g">1</span></div>
  </div>
  <div role="cell"
    class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51u _6zbcq51r _1fragem87 _6zbcq51p _6zbcq51n _1fragemny">
    <div class="_197l2ofx _1fragemp7 _1fragemnu _1fragem3c _1fragemn2 Byb5s"><span translate="no"
        class="_19gi7yt0 _19gi7yt12 _19gi7yt1a _19gi7yt1g notranslate">$1.97</span></div>
  </div>
</div>
`;

let checkoutWidgetHTML = `
<div class="Geu8c" style="">
  <div class="M4bqA Geu8c" style="">
    <div class="_1fragem32 _1fragemn2">
      <div>
        <div class="_1fragem32 _1fragemn2">
          <div class="_16s97g74v"></div>
          <div class="_1fragem32 _1fragemn2">
            <div
              class="_4jeq6k0 _1fragemn2 _1fragema _1fragemns _1fragem41 _1fragem50 _1fragem6t _1fragemnh _16s97g7f _16s97g7p _16s97g71j _16s97g71t"
              style="--_16s97g7a: minmax(auto, max-content); --_16s97g7k: minmax(0, 1fr); --_16s97g71e: minmax(auto, max-content); --_16s97g71o: minmax(0, 1fr);">
              <div>
                <div class="_1mmswk92 _1mmswk91 _1fragemn2 _1fragem3c">
                  <div class="_1mmswk94 _1mmswk93 _1fragemn2 _1fragempb"><input type="checkbox" id="DeprecatedCheckbox0"
                      class="_1mmswk96 _1mmswk95 _1fragemqe _1fragemqc _1fragemqg _1fragemqa _1fragemre _1fragemra _1fragemri _1fragemr6 _1fragemci _1fragemby _1fragemd2 _1fragembe _1fragemp4 _1fragem32 _1fragempz _1fragem2x _1fragemub _1fragemu5 _1fragemui _1mmswk97 _1fragemov _1mmswk9a _1mmswk98 _1fragemuu">
                    <div
                      class="_1mmswk9k _1mmswk9j _1fragemov _1fragemtw _1fragemtc _1fragemms _1fragemu5 _1fragemul _1fragemub">
                      <span
                        class="a8x1wu2 a8x1wu1 _1fragempz _1fragem2x _1fragemly _1fragemlo a8x1wu9 a8x1wui a8x1wum a8x1wuk _1fragem32 a8x1wup a8x1wuo a8x1wuw"><svg
                          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" focusable="false" aria-hidden="true"
                          class="a8x1wuy a8x1wux _1fragem32 _1fragempz _1fragemly _1fragemlo _1fragemp6">
                          <path stroke-linecap="round" stroke-linejoin="round"
                            d="m1.5 7.097 3.596 3.602c.104.105.156.157.216.175a.25.25 0 0 0 .16-.004c.059-.022.108-.077.206-.188L12.5 3">
                          </path>
                        </svg></span></div>
                  </div>
                </div>
              </div><span class="_19gi7yt0 _19gi7yti _19gi7yth _1fragemph _19gi7yt12 _19gi7yt1a _19gi7yt1g">SavedBy
                Package Protection</span>
              <div class="_197l2ofx _1fragemp7 _1fragemns _1fragem3c _1fragemn2"><button type="button"
                  class="_1m2hr9ge _1m2hr9gd _1fragemum _1fragemn2 _1fragemp4 _1fragemu0 _1fragemuf _1fragemuh _1fragemu6 _1m2hr9g1h _1m2hr9g1e _1fragemuh _1fragemuf _1fragemu5 _1fragemtr _1m2hr9gi _1m2hr9gg _1fragem3m _1m2hr9g1w _1m2hr9g1a _1m2hr9g18 _1fragemq0 _1m2hr9g1j _1m2hr9g1i _1fragemu2"
                  aria-haspopup="dialog"><span
                    class="_1m2hr9gv _1m2hr9gu _1fragemtw _1fragemub _1fragemu5 _1fragemui _1m2hr9gr _1m2hr9gp _1fragem3c _1fragem87 _1fragemty"><span
                      class="a8x1wu2 a8x1wu1 _1fragempz _1fragem2x _1fragemly _1fragemlo a8x1wu9 a8x1wui a8x1wum a8x1wuk _1fragem32 a8x1wur a8x1wuo a8x1wuw"><svg
                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" focusable="false" aria-hidden="true"
                        class="a8x1wuy a8x1wux _1fragem32 _1fragempz _1fragemly _1fragemlo _1fragemp6">
                        <g clip-path="url(#a)">
                          <circle cx="7" cy="7" r="5.5"></circle>
                          <path stroke-linejoin="round" d="M6.99 10.24h.02v.02h-.02z"></path>
                          <path stroke-linecap="round"
                            d="M5.5 5.25a1.5 1.5 0 1 1 2.428 1.179C7.494 6.77 7 7.198 7 7.75"></path>
                        </g>
                        <defs>
                          <clipPath id="a">
                            <path fill="#fff" d="M0 0h14v14H0z"></path>
                          </clipPath>
                        </defs>
                      </svg></span></span></button></div>
            </div>
          </div>
          <div class="_16s97g74v"></div>
          <p class="_1tx8jg70 _1fragemn2 _1tx8jg715 _1tx8jg71d _1tx8jg71g _1tx8jg7a _1tx8jg79 _1fragempf">Add SavedBy
            for peace of mind against lost, stolen, or damaged packages.</p>
        </div>
      </div>
    </div>
  </div>
</div>
`;

console.log("Shopify Checkout Button Modifier initialized");

function formatPrice(cents) {
	return `$${(cents / 100).toFixed(2)}`;
}

let tierRate = "035";
function getFeeTiers(rate) {
	//
	switch (rate) {
		case "035":
			return feeTiers035;
		default:
			console.warn(`Unknown tier rate: ${rate}. Defaulting to 035.`);
			return feeTiers035;
	}
}

function calculateFee(cents) {
	const feeTiers = getFeeTiers(tierRate);
	console.log("Fee tiers:", feeTiers);

	for (const tier of feeTiers) {
		if (cents <= tier.max * 100) {
			return tier.fee * 100;
		}
	}
}

function createCheckoutPlus(button, fee) {
	const widget = document.createElement("savedby-checkout-plus");
	console.log("Creating widget for button:", button);
	widget.id = "savedby-checkout-plus-widget";
	widget.style.display = "block";
	widget.style.width = "100%";

	widget.innerHTML = `
  <style id="extra-css"></style>
  <style>
    a.sb__non-covered-link.double-button {
      color: rgb(145, 163, 149);
      text-decoration: none;
      opacity: unset;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 58px;
      border: 2px solid rgb(145, 163, 149);
      box-sizing: border-box;
      border-radius: 10px;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      line-height: 1.5;
    }

    .sb__parent {
      margin-bottom: 12px;
      margin-top: 16px;
      max-width: var(--container-max-width, 100%);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hs-site-cart-popup-layout savedby-widget .sb__container,
    #slidecarthq .sb__container,
    #rebuy-cart .sb__container,
    #rebuy-cart .sb__checkout-container {
      max-width: 100%;
    }

    .sb__info-wrapper {
      display: flex;
      width: 100%;
      line-height: 1;
      margin: 0;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      letter-spacing: 0.01em;
      vertical-align: middle;
    }

    .sb__info-wrapper:has(+ slot) {
      margin-bottom: 0;
    }

    .sb__info-container {
      border-radius: var(--info-border-radius, 4px);
      display: flex;
      gap: 0 8px;
      padding: 4px 8px;
      justify-content: center;
      min-height: 16px;
      background-color: var(--info-bg-color, #f5f5f5);
      color: var(--info-text-color, #000000);
      width: 100%;
      align-items: center;
      mix-blend-mode: normal;
      backdrop-filter: blur(10px);
    }

    /* INFO LOGO */

    .sb__info-logo-container {
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    [data-variant=DETAILED] .sb__info-logo-container {
      height: auto;
    }

    .sb__info-logo-container>img {
      height: 100%;
      aspect-ratio: 1;
      max-width: 28px;
    }

    /* INFO CONTENT */
    .sb__info-content {
      display: flex;
      flex-direction: column;
      text-align: left;
      padding: 4px 0;
      flex: auto;
    }

    /* INFO TEXT */

    .sb__info-text-wrapper {
      flex: 1;
      display: flex;
    }

    .sb__info-text-container {
      column-gap: 4px;
      display: flex;
      flex-wrap: wrap;
      font-size: var(--info-font-size, 0.8em);
      align-items: center;
    }

    [data-variant=DETAILED] .sb__info-text-container {
      width: 100%;
    }

    .sb__info-text-container [name="title"] {
      font-size: var(--info-title-font-size, 16px);
      font-weight: 400;
      color: var(--info-title-color, inherit);
    }

    [data-variant=DETAILED] [name="title"] {
      font-size: var(--info-title-font-size, 14px);
    }

    .sb__info-container [name="description"] {
      font-weight: 100;
      white-space: nowrap;
      font-size: var(--info-desc-font-size, 1.1em);
      color: var(--info-desc-color, inherit);
    }

    [data-variant=DETAILED] [name="description"] {
      opacity: 0.8;
      font-size: var(--info-desc-font-size, 14px);
    }

    .sb__info-text-container [name="fee"] {
      font-weight: 100;
      color: var(--info-fee-color, inherit);
      font-size: var(--info-fee-font-size, 1.1em);
      text-align: right;
      flex: auto
    }

    [data-variant=SIMPLE] [name="fee"]::before {
      content: "â€¢";
      margin: 0 4px;
    }

    [data-variant=DETAILED] [name="fee"] {
      opacity: 0.8;
    }

    /* INFO HELP BUTTON */

    .sb__info-help-button {
      /* padding-left: 4px; */
      /* background-color: red; */
      height: 18px;
      width: 18px;
      max-height: 24px;
      max-width: 24px;
      cursor: pointer;
      opacity: 0.5
    }

    [data-variant=DETAILED] .sb__info-help-button {
      /* background-color: red;s */
      height: 18px;
      width: 18px;
    }

    .sb__info-help-button>svg {
      fill: var(--info-help-color, #000000);
    }

    @media (max-width: 330px) {
      .sb__info-container {
        background-color: unset;
      }

      .sb__info-text-container {
        font-size: 12px;
      }
    }

    .sb__checkout-wrapper {
      justify-content: center;
      width: 100%;
    }

    .sb__checkout-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      gap: 16px;
    }

    .sb__button-wrapper {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 16px;
      width: 100%;
      flex-wrap: wrap;
    }

    .sb__button {
      display: flex;
      border-radius: var(--btn-border-radius, 5px);
      height: var(--btn-height, 54px);
      justify-content: center;
      align-items: center;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      border-width: 0;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      white-space: nowrap;
    }

    .sb__checkout-button {
      background-color: var(--btn-checkout-bg-color, #000000);
      color: var(--btn-checkout-text-color, #ffffff);
    }

    .sb__checkout-button>svg {
      fill: var(--btn-checkout-text-color, #ffffff);
    }

    .sb__button:hover {
      filter: brightness(0.9);
    }

    /* TODO -- DOESNT WORK INSIDE SHADOW ROOT */
    slot[name="checkoutButton"][disabled] {
      filter: grayscale(0.9);
      cursor: not-allowed;
      opacity: 0.3;
    }

    .sb__cart-button {
      background-color: var(--btn-cart-bg-color, #ffffff);
      color: var(--btn-cart-text-color, #000000);
    }

    /* TODO -- LOADING */
    .sb__loading-icon,
    .sb__loading-icon div {
      box-sizing: border-box;
    }

    .sb__loading-icon {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }

    .sb__loading-icon div {
      position: absolute;
      top: 33.33333px;
      width: 13.33333px;
      height: 13.33333px;
      border-radius: 50%;
      background: currentColor;
      animation-timing-function: cubic-bezier(0, 1, 1, 0);
    }

    .sb__loading-icon div:nth-child(1) {
      left: 8px;
      animation: sb__loading-icon1 0.6s infinite;
    }

    .sb__loading-icon div:nth-child(2) {
      left: 8px;
      animation: sb__loading-icon2 0.6s infinite;
    }

    .sb__loading-icon div:nth-child(3) {
      left: 32px;
      animation: sb__loading-icon2 0.6s infinite;
    }

    .sb__loading-icon div:nth-child(4) {
      left: 56px;
      animation: sb__loading-icon3 0.6s infinite;
    }

    @keyframes sb__loading-icon1 {
      0% {
        transform: scale(0);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes sb__loading-icon3 {
      0% {
        transform: scale(1);
      }

      100% {
        transform: scale(0);
      }
    }

    @keyframes sb__loading-icon2 {
      0% {
        transform: translate(0, 0);
      }

      100% {
        transform: translate(24px, 0);
      }
    }

    .sb__continue-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .sb__non-covered-link {
      color: var(--continue-text-color, #000000);
      font-size: var(--continue-font-size, 13px);
      text-decoration: var(--continue-text-decoration, underline);
      text-align: center;
      cursor: pointer;
      width: auto;
      opacity: 0.7;
      font-weight: 300;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
    }

    div:has(>.sb__non-covered-link[disabled]) {
      cursor: not-allowed;
    }

    .sb__non-covered-link[disabled] {
      pointer-events: none;
      filter: grayscale(0.9);
    }

    .sb__disclaimer {
      color: var(--disclaimer-text-color, gray);
      font-size: var(--disclaimer-font-size, 14px);
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      text-decoration: var(--disclaimer-text-decoration, none);
      font-style: var(--disclaimer-text-style, italic);
      font-weight: var(--disclaimer-font-weight, 300);
      line-height: 1.2;
      text-align: center;
    }
  </style>
  <div class="sb__parent">
    <div data-variant="SIMPLE" class="sb__info-wrapper">
      <div class="sb__info-container">
        <div class="sb__info-logo-container"><img alt="Protection Logo"
            src="https://cdn.savedby.io/logos/savedby/SavedByLogo-small.png"></div>
        <div class="sb__info-text-wrapper">
          <div class="sb__info-text-container"><span name="title">Checkout+</span>
            <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
              <span name="description">Package Protection</span><span name="fee">$${fee || "1.67"}</span>
            </div>
          </div>
        </div>
        <div class="sb__info-help-button"><svg xmlns="http://www.w3.org/2000/svg" height="100%" focusable="false"
            aria-hidden="true" viewBox="0 0 24 24">
            <path
              d="M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4">
            </path>
          </svg></div>
      </div>
    </div>
    <div class="sb__viewCart-container" style="display: none;">
      <view-cart-button />
    </div>
    <div class="sb__checkoutBtn-container">
      <checkout-button />
    </div>
    <div class="sb__continue-container">
      <a class="sb__non-covered-link">Continue without package protection</a>
    </div>
    <div class="sb__disclaimer">
      <span>We highly suggest protecting your package with Checkout+ for lost, damaged, or stolen packages.</span>
    </div>
  `;
	//copy the button node
	const btnCopy = button.cloneNode(true);
	widget.querySelector("checkout-button").replaceWith(button.cloneNode(true));
	console.log("Button replaced in widget:", btnCopy);
	const viewCartButton = button.parentNode.querySelector("a[href*='cart']");
	if (viewCartButton) {
		widget.querySelector(".sb__viewCart-container").style.display = "flex";
		widget.querySelector("view-cart-button").replaceWith(viewCartButton.cloneNode(true));
	}
	widget.querySelector("div.sb__info-container").style.borderRadius = window.getComputedStyle(button).borderRadius || "4px";
	button.replaceWith(widget);
	console.log("Widget created and button replaced:", widget);
}

function replaceTextInNode(root, newText) {
	const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
	let node;
	while ((node = walker.nextNode())) {
		if (node.nodeValue?.trim()) {
			node.nodeValue = newText;
			break;
		}
	}
}

function updateCheckoutButton(totalPrice) {
	console.log("Updating checkout button with cart data:", totalPrice);
	const fee = calculateFee(totalPrice);
	const newTotal = totalPrice + fee;
	console.log("Calculated fee:", fee, "New total:", newTotal);
	const label = `Checkout+ ${formatPrice(newTotal)}`;

	const buttons = document.querySelectorAll('button[name="checkout"], a[href*="checkout"], input[name="checkout"], button.rebuy-cart__checkout-button, button#addon-checkout');
	if (!buttons.length) return;
	buttons.forEach((button) => {
		console.log("Found checkout button:", button);
		if (button.type === "hidden") return;
		if (button.tagName === "INPUT") {
			button.value = label;
		} else {
			replaceTextInNode(button, label);
		}
		createCheckoutPlus(button, fee / 100);
	});
}

function createCheckBoxWidget(section) {
	if (document.getElementById(`savedby-checkbox-widget-${section}`)) return;
	console.log("Creating checkbox widget...");
	const widget = document.createElement("div");
	widget.id = "savedby-checkbox-widget";
	widget.innerHTML = checkoutWidgetHTML;
	console.log("Checkbox widget created:", widget);
	return widget;
}

function displayProductInCart() {
	if (document.getElementById("savedby-product-card")) return;
	console.log("Creating product card...");
	const productCard = document.createElement("div");
	productCard.id = "savedby-product-card";
	productCard.style.marginTop = "12px";
	productCard.innerHTML = productHTML;
	console.log("Product card created:", productCard);
	return productCard;
}

function populateCheckoutPage() {
	const checkBoxWidget = createCheckBoxWidget();
	const productCard = displayProductInCart();
	const orderSummary = document.getElementById("gift-card-field");
	const productList = document.querySelector('[role="table"] [role="rowgroup"]:has([role="cell"] img)');
	if (orderSummary) {
		orderSummary.insertAdjacentElement("afterend", checkBoxWidget);
	}
	if (productList) {
		productList.insertAdjacentElement("beforeend", productCard);
	}

	// else {
	//   const section2 = document.querySelector(".section--shipping-address");
	//   if (section2) {
	//     section2.insertAdjacentElement("beforebegin", checkBoxWidget);
	//   } else {
	//     document.body.appendChild(checkBoxWidget);
	//   }
	// }
}

function injectLabel() {
	console.log("Injecting label into checkout page...");
	if (window.location.pathname.includes("/checkout")) {
		console.log("Checkout page detected, populating checkout page with label.");
		populateCheckoutPage();
		console.log("Shopify theme not detected, injecting label directly into checkout page.");
		return;
	}

	console.log("Shopify theme detected, fetching cart data to update checkout button.");
	fetch("/cart.js?view=checkout")
		.then((res) => res.json())
		.then((cart) => {
			updateCheckoutButton(cart.total_price);
		})
		.catch((err) => {
			console.error("Error fetching cart data:", err);
			updateCheckoutButton(7000);
		});
}

// function createSidebarButton() {
// 	const btn = document.createElement("button");
// 	btn.id = "activate-checkout-modifier";
// 	btn.innerText = "Activate Checkout Modifier";
// 	btn.style.position = "fixed";
// 	btn.style.top = "20px";
// 	btn.style.right = "20px";
// 	btn.style.zIndex = "2147483647";
// 	btn.style.padding = "10px 15px";
// 	btn.style.backgroundColor = "#000";
// 	btn.style.color = "#fff";
// 	btn.style.border = "none";
// 	btn.style.borderRadius = "5px";
// 	btn.style.cursor = "pointer";
// 	btn.style.boxShadow = "0 0 10px rgba(0,0,0,0.2)";
// 	document.body.appendChild(btn);

// 	btn.addEventListener("click", () => {
// 		console.log("Sidebar button clicked, injecting label...");
// 		injectLabel();
// 	});
// }

function createSideBar() {
	const sidebar = document.createElement("div");
	sidebar.id = "checkout-modifier-sidebar";
	sidebar.style.position = "fixed";
	sidebar.style.top = "0";
	sidebar.style.left = "0";
	sidebar.style.width = "300px";
	sidebar.style.height = "100%";
	sidebar.style.zIndex = "2147483647";
	sidebar.style.backgroundColor = "#fff";
	sidebar.style.display = "none";

	document.body.appendChild(sidebar); // Append sidebar to body first;

	const openIcon = document.createElement("div");
	openIcon.id = "open-checkout-modifier-icon";
	openIcon.style.position = "fixed";
	openIcon.style.top = "20px";
	openIcon.style.left = "0";
	openIcon.style.zIndex = "2147483646";
	openIcon.style.width = "50px";
	openIcon.style.height = "60px";
	openIcon.style.borderRadius = "0 30px 30px 0";
	openIcon.style.backgroundColor = "#007bff";
	openIcon.style.color = "#fff";
	openIcon.style.display = "flex";
	openIcon.style.alignItems = "center";
	openIcon.style.justifyContent = "center";
	openIcon.style.cursor = "pointer";
	openIcon.style.boxShadow = "0 2px 10px rgba(0,0,0,0.3)";
	openIcon.style.fontSize = "12px";
	openIcon.style.fontWeight = "bold";
	openIcon.style.fontFamily = "Arial, sans-serif";
	openIcon.innerHTML = "&lt;"; // Add content to prevent div:empty CSS rule
	openIcon.title = "Open Checkout Modifier"; // Add tooltip
	document.body.appendChild(openIcon); // Append open icon to body
	openIcon.addEventListener("click", () => {
		sidebar.style.display = sidebar.style.display === "none" ? "block" : "none";
	});

	const shadow = sidebar.attachShadow({ mode: "open" });

	const style = document.createElement("style");
	style.textContent = `
    #sidebar-content {
      font-family: Arial, sans-serif;
      color: #333;
      padding: 10px
    }
    #close-sidebar {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
    }
    #sidebar-content-inner {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button#activate-checkout-modifier {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    button#activate-checkout-modifier:hover {
      background-color: #0056b3;
    }
  `;
	shadow.appendChild(style);

	const sideBarContent = document.createElement("div");
	sideBarContent.id = "sidebar-content";
	sideBarContent.innerHTML = `
    <button id="close-sidebar">Close Sidebar</button>
    <div id="sidebar-content-inner"> 
      <h2>Checkout Modifier</h2>
      <p>Click the button to activate the checkout modifier.</p>
      <button id="activate-checkout-modifier">Activate Checkout Modifier</button>
      <div id="modifier-options" style="display: none;">
        <div id="disclaimer-container">
          <div id="disclaimer-toggle">
            <input type="checkbox" id="disclaimerDisplay" name="disclaimerDisplay" value="true" checked>
            <label for="disclaimerDisplay">Enable Disclaimer</label>
          </div>
          <input type="text" id="disclaimerText" name="disclaimerText" placeholder="Enter disclaimer text here" style="display: block;">
        </div>
        <div id="button-container">
          <div id="button-toggle">
            <input type="checkbox" id="buttonDisplay" name="buttonDisplay" value="true" checked>
            <label for="buttonDisplay">Enable Double Button</label>
          </div>
          <div id="double-button-container">
            <button id="double-button-preview">Preview Double Button</button>
          </div>
        </div>
      </div>
    </div>
  `;
	shadow.appendChild(sideBarContent);

	shadow.querySelector("#close-sidebar").addEventListener("click", () => {
		sidebar.style.display = "none";
	});

	shadow.querySelector("#activate-checkout-modifier").addEventListener("click", () => {
		console.log("Sidebar button clicked, injecting label...");
		injectLabel();
		shadow.querySelector("#modifier-options").style.display = "block";
	});

	shadow.querySelector("#disclaimerDisplay").addEventListener("change", ({ target }) => {
		const disclaimerText = shadow.querySelector("#disclaimerText");
		if (target.checked) {
			disclaimerText.style.display = "block";
			disclaimerText.placeholder = "Enter disclaimer text here";
			document.querySelector(".sb__disclaimer").style.display = "block";
		} else {
			disclaimerText.style.display = "none";
			// disclaimerText.value = "";
			document.querySelector(".sb__disclaimer").style.display = "none";
		}
	});

	shadow.querySelector("#disclaimerText").addEventListener("input", ({ target }) => {
		const disclaimerText = target.value;
		if (disclaimerText) {
			document.documentElement.style.setProperty("--disclaimer-text", disclaimerText);
			document.querySelector(".sb__disclaimer").textContent = disclaimerText;
		} else {
			document.documentElement.style.removeProperty("--disclaimer-text");
			document.querySelector(".sb__disclaimer").textContent = "We highly suggest protecting your package with Checkout+ for lost, damaged, or stolen packages.";
		}
	});

	shadow.querySelector("#buttonDisplay").addEventListener("input", ({ target }) => {
		const buttonDisplay = target.checked;
		if (buttonDisplay) {
			const checkoutButton = document.querySelectorAll(".sb__checkoutBtn-container > *");

			if (checkoutButton.length > 0) {
				checkoutButton.forEach((button) => {
					const parent = button.closest(".sb__parent");
					const buttonLink = parent.querySelector(".sb__non-covered-link");

					console.log("Button link:", buttonLink, button);
					// Get computed styles from the checkout button
					const computedStyle = window.getComputedStyle(button);

					// Extract key styles
					const backgroundColor = computedStyle.backgroundColor;
					const color = computedStyle.color;
					const height = computedStyle.height;
					const borderRadius = computedStyle.borderRadius;
					const border = computedStyle.border;
					const fontSize = computedStyle.fontSize;
					const fontWeight = computedStyle.fontWeight;
					const padding = computedStyle.padding;
					const fontFamily = computedStyle.fontFamily;

					// Apply button-like styles to the link
					buttonLink.style.cssText = `
					color: ${backgroundColor};
					border-radius: ${borderRadius};
					font-size: ${fontSize};
					padding: ${padding};
					font-weight: ${fontWeight};
					min-height: ${height};
					border: 2px solid ${backgroundColor};
					font-family: ${fontFamily};
					text-decoration: none;
					opacity: unset;
					display: inline-flex;
					align-items: center;
					justify-content: center;
					width: 100%;
					box-sizing: border-box;
					line-height: 1.5;
					background-color: transparent;
					cursor: pointer;
				`;

					// Add hover effect
					buttonLink.addEventListener("mouseenter", () => {
						buttonLink.style.backgroundColor = color;
						buttonLink.style.color = backgroundColor === "rgba(0, 0, 0, 0)" ? "#ffffff" : backgroundColor;
					});

					buttonLink.addEventListener("mouseleave", () => {
						buttonLink.style.backgroundColor = "transparent";
						buttonLink.style.color = color;
					});
				});
			}
		}
	});

	console.log("Sidebar created:", sidebar);
}

if (document.readyState === "loading") {
	document.addEventListener("DOMContentLoaded", () => {
		console.log("DOMContentLoaded");
		createSideBar();
		// createSidebarButton();
	});
} else {
	console.log("DOM already loaded");
	createSideBar();
	// createSidebarButton();
}

const feeTiers035 = [
	{
		max: 70,
		fee: 1.67,
	},
	{
		max: 100,
		fee: 2.97,
	},
	{
		max: 150,
		fee: 4.47,
	},
	{
		max: 200,
		fee: 5.97,
	},
	{
		max: 250,
		fee: 7.97,
	},
	{
		max: 300,
		fee: 9.47,
	},
	{
		max: 350,
		fee: 11.47,
	},
	{
		max: 400,
		fee: 12.97,
	},
	{
		max: 450,
		fee: 14.97,
	},
	{
		max: 500,
		fee: 16.47,
	},
	{
		max: 550,
		fee: 18.47,
	},
	{
		max: 600,
		fee: 19.97,
	},
	{
		max: 650,
		fee: 21.97,
	},
	{
		max: 700,
		fee: 23.47,
	},
	{
		max: 750,
		fee: 25.47,
	},
	{
		max: 800,
		fee: 26.97,
	},
	{
		max: 850,
		fee: 28.97,
	},
	{
		max: 900,
		fee: 30.47,
	},
	{
		max: 950,
		fee: 32.47,
	},
	{
		max: 1000,
		fee: 33.97,
	},
	{
		max: 1050,
		fee: 35.97,
	},
	{
		max: 1100,
		fee: 37.47,
	},
	{
		max: 1150,
		fee: 39.47,
	},
	{
		max: 1200,
		fee: 40.97,
	},
];
